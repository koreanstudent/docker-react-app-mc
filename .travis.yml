
os: linux
language: node_js 

services:
  - docker

before_install:
  - echo "start creating an image with dockerfile"
  - docker build -t student/docker-react-app -f Dockerfile.dev .

script:
  - docker run -e CI=true student/docker-react-app npm run test -- --coverage

after_success:
  - echo "Test success !!"

before_deploy:
  - zip -r docker-react-app
  - mkdir -p deploy
  - mv docker-react-app.zip deploy/docker-react-app.zip

deploy:
 - provider: s3
   bucket: docker-bucket-test
   region: ap-northeast-2
   local_dir: deploy
   skip_cleanup: true
   wait_until_deployed : true
   access_key_id: $AWS_ACCESS_KEY
   secret_access_key: $AWS_SECRET_ACCESS_KEY
   on:
     repo: koreanstudent/docker-react-app-mc
     branch: master

- provider: codedeploy
  access_key_id: $AWS_ACCESS_KEY
  secret_access_key: $AWS_SECRET_ACCESS_KEY
  bucket: ci/cd Lightsail
  key: docker-react-app.zip
  bundle_type: zip
  application: Lightsail-codedeploy-app
  deployment_group: Lightsail-codedeploy-group
  region: ap-northeast-2
  wait_until_deployed : true
  on:
    repo: koreanstudent/docker-react-app-mc
    branch: master
    

    
notifications:
  email:
    recipients:
      - hn12344@naver.com
 
 